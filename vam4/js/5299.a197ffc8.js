"use strict";(self["webpackChunkmeetingvue3"]=self["webpackChunkmeetingvue3"]||[]).push([[5299],{55299:function(e,t,s){s.r(t),s.d(t,{default:function(){return z}});s(44114),s(18111),s(22489),s(7588),s(61701);var l=s(20641),a=s(90033),n=s(53751),i=s(50953),o=s(95531),r=s(40834),c=s(71029);const p={class:"remark-config"},d={class:"tab-panel"},u={class:"content-layout"},k={class:"invoice-section"},L={class:"invoice-container figure"},h={class:"invoicedialog_table"},g={class:"invoicedialog_tr"},v={class:"table invoicedialog_flot"},m={class:"content"},y={class:"table_p table_center"},f={style:{width:"293px"}},_={class:"invoicedialog_tr bottom header"},w={class:"notice_input invoicedialog_flot"},x=["onUpdate:modelValue","placeholder","onDrop"],b={class:"variable-section"},$={class:"variable-panel"},I={class:"variable-header"},C={class:"variable-content"},R={class:"category-title"},E={class:"variable-tags"},K=["onDragstart","onClick","title"],D={class:"variable-code"},M={class:"save-section"};var j={__name:"remarkConfig",setup(e){const t=(0,c.lq)(),s=(0,r.Pj)(),{proxy:j}=(0,l.nI)(),W=(0,i.KR)("register"),X=(0,i.Kh)([{name:"register",label:"注册"},{name:"hotel",label:"酒店"}]),z=(0,i.Kh)({register:"",hotel:"",paper:""}),F=(0,i.Kh)({register:null,hotel:null,paper:null}),T=(0,i.KR)(!0),q=(0,i.KR)(!1),V=(0,i.KR)(!1),P=(0,i.Kh)([]),S=(0,i.KR)(window.innerWidth),O=((0,i.KR)(1),e=>{console.log("切换到tab:",e),console.log(`当前${e}备注内容:`,z[e])}),A=()=>{T.value=!T.value},U=(e,t)=>{e.dataTransfer.setData("text/plain",t.value),e.dataTransfer.effectAllowed="copy"},B=(e,t)=>{e.preventDefault();const s=e.dataTransfer.getData("text/plain");if(s){const l=e.target,a=l.selectionStart,n=z[t],i=n.slice(0,a)+s+n.slice(a);z[t]=i,setTimeout(()=>{l.selectionStart=l.selectionEnd=a+s.length,l.focus()},0)}},G=e=>{const t=W.value,s=z[t];z[t]=s+(s?" ":"")+e.value},J=()=>{S.value;const e=1100,t=document.querySelectorAll(".invoicedialog_table"),s=document.querySelector(".invoice-container"),l=s.clientWidth-20;console.log(l,"width"),[...t].forEach(t=>{t.style.zoom=l/e})},Y=()=>{S.value=document.querySelector(".invoice-section").offsetWidth,window.innerWidth<=1440||J()};function H(e,t){(0,l.dY)(()=>{Y()})}const N=()=>{window.addEventListener("resize",Y)},Q=()=>{window.removeEventListener("resize",Y)},Z=async()=>{try{q.value=!0,j.$Loadimg.showLoading();const e=t.query.meeting||null,l=s.state.user?.committeeId;if(!l)return void o.nk.error("缺少组委会信息，无法保存配置");const a=[],n={register:1,hotel:2,paper:3};for(const[t,s]of Object.entries(n)){const n=z[t];if(n.trim()){const i={meetingId:e,committeeId:l,committeeRemark:n,meetingRemark:"",type:s};F[t]?(i.id=F[t],a.push(j.$http.article.addInvoiceRemarkConfig(i).catch(e=>{console.error(`编辑${t}备注失败:`,e);const s=e.response?.data?.msg||`编辑${t}备注失败`;return{error:!0,type:t,errorMsg:s}}))):a.push(j.$http.article.addInvoiceRemarkConfig(i).catch(e=>{console.error(`添加${t}备注失败:`,e);const s=e.response?.data?.msg||`添加${t}备注失败`;return 0===e.response?.data?.status&&e.response?.data?.msg?.includes("已存在备注配置")?(console.log(`${t}备注已存在，尝试获取配置后编辑`),{error:!0,type:t,needReload:!0,errorMsg:s}):{error:!0,type:t,errorMsg:s}}))}}if(0===a.length)return void o.nk.warning("请至少填写一种类型的备注信息");const i=await Promise.all(a),r=i.filter(e=>e.error),c=i.filter(e=>!e.error),p=i.filter(e=>e.error&&e.needReload);if(p.length>0){console.log("检测到已存在的配置，重新加载后尝试编辑"),await ee();const t=[];for(const s of p){const a=s.type,i=n[a],o=z[a];if(o.trim()&&F[a]){const s={meetingId:e,committeeId:l,committeeRemark:o,meetingRemark:"",type:i,id:F[a]};t.push(j.$http.article.editInvoiceRemarkConfig(s).catch(e=>{console.error(`重试编辑${a}备注失败:`,e);const t=e.response?.data?.msg||`重试编辑${a}备注失败`;return{error:!0,type:a,errorMsg:t}}))}}if(t.length>0){const e=await Promise.all(t),s=e.filter(e=>e.error);if(0===s.length)o.nk.success("备注配置保存成功！"),await ee();else{const e=s.map(e=>e.errorMsg).join("；");o.nk.error(e)}}}else if(0===r.length)o.nk.success("备注配置保存成功！"),await ee();else if(c.length>0){const e=r.map(e=>e.errorMsg).join("；");o.nk.warning(`部分配置保存成功，但有${r.length}项失败：${e}`),await ee()}else{const e=r.map(e=>e.errorMsg).join("；");o.nk.error(e)}}catch(e){console.error("保存失败:",e);const t=e.response?.data?.msg||"保存失败，请重试";o.nk.error(t)}finally{q.value=!1,j.$Loadimg.hideLoading()}},ee=async()=>{try{V.value=!0,j.$Loadimg.showLoading();const e=s.state.user?.committeeId,l=t.query.meeting||null;if(!e)return void console.warn("缺少组委会信息，无法加载远程配置");const a={1:"register",2:"hotel",3:"paper"},n=[];for(const[t,s]of Object.entries(a)){const a={meetingId:l,committeeId:e,type:parseInt(t)};n.push(j.$http.article.getInvoiceRemarkConfig(a).then(e=>1===e.data.status||200===e.data.status?{type:s,data:e.data.data||e.data.list,success:!0}:(console.warn(`加载${s}备注配置失败:`,e.data.msg),{type:s,success:!1,errorMsg:e.data.msg})).catch(e=>{console.error(`加载${s}备注配置错误:`,e);const t=e.response?.data?.msg||`加载${s}备注配置错误`;return{type:s,success:!1,errorMsg:t}}))}const i=await Promise.all(n);let o=!1;i.forEach(e=>{e.success&&e.data&&e.data&&(z[e.type]=e.data.committeeRemark||"",F[e.type]=e.data.id||null,o=!0)}),o?console.log("远程配置加载成功"):console.log("未找到远程配置数据")}catch(e){console.error("加载远程配置失败:",e)}finally{V.value=!1,j.$Loadimg.hideLoading()}},te=async()=>{try{V.value=!0,j.$Loadimg.showLoading();const e=s.state.user?.committeeId,t=s.state.user?.meetingId||null;if(!e)return void console.warn("缺少组委会信息，无法获取变量配置");const l={committeeId:e,meetingId:t};console.log("获取发票变量配置参数:",l);const a=await j.$http.article.getInvoiceRemarks(l);if(1===a.data.status||200===a.data.status){const e=a.data.list||{};P.splice(0);const t={meeting:"会议信息",hotel:"酒店信息",paper:"论文信息",committee:"组委会信息"};Object.keys(e).forEach(s=>{const l=e[s],a=[];Object.keys(l).forEach(e=>{const t=l[e];a.push({key:t,display:e,value:`{ ${t} }`,description:e})}),a.length>0&&P.push({name:s,title:t[s]||s,variables:a})}),console.log("变量配置加载成功:",P)}else console.warn("获取变量配置失败:",a.data.msg)}catch(e){console.error("获取变量配置错误:",e)}finally{V.value=!1,j.$Loadimg.hideLoading()}};return(0,l.wB)(()=>s.state?.user?.committeeId,e=>{e&&(console.log("组委会ID变化，重新加载备注配置:",e),te(),ee())},{immediate:!0}),(0,l.sV)(()=>{document.documentElement.style.setProperty("--invoice-color","#aa5555"),J(),N(),Y(),s.state.user?.committeeId&&(te(),ee())}),(0,l.hi)(()=>{Q()}),(e,t)=>{const s=(0,l.g2)("el-button"),i=(0,l.g2)("el-tab-pane"),o=(0,l.g2)("el-tabs");return(0,l.uX)(),(0,l.CE)("div",p,[(0,l.bF)(o,{modelValue:W.value,"onUpdate:modelValue":t[2]||(t[2]=e=>W.value=e),type:"card",class:"custom-tabs",onTabChange:O},{default:(0,l.k6)(()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(X,e=>((0,l.uX)(),(0,l.Wv)(i,{key:e.name,label:e.label,name:e.name,onTabClick:H},{default:(0,l.k6)(()=>[(0,l.Lk)("div",d,[(0,l.Lk)("div",u,[(0,l.Lk)("div",k,[(0,l.Lk)("div",L,[(0,l.Lk)("div",h,[t[14]||(t[14]=(0,l.Lk)("div",{class:"invoicedialog_tr header"},[(0,l.Lk)("div",{class:"invoicedialog_flot notice purchaser_text"},"购买方"),(0,l.Lk)("div",{class:"invoicedialog_flot notice_input"},[(0,l.Lk)("p",{class:"w-100"},[(0,l.Lk)("span",{class:"purchaser_text",style:{width:"84px",overflow:"hidden","vertical-align":"sub"}},[(0,l.Lk)("span",{style:{float:"left"}},"名"),(0,l.Lk)("span",{style:{float:"right"}},"称：")]),(0,l.Lk)("span",null,"---")]),(0,l.Lk)("p",{class:"w-100"},[(0,l.Lk)("span",{class:"purchaser_text"},"纳税人识别号："),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("p",{class:"more_msg"},[(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},[(0,l.Lk)("i",null,"购"),(0,l.Lk)("i",null,"方"),(0,l.Lk)("i",null,"地"),(0,l.Lk)("i",null,"址：")]),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},[(0,l.Lk)("i",null,"电"),(0,l.Lk)("i",null,"话：")]),(0,l.Lk)("span",null,"----")])]),(0,l.Lk)("p",{class:"more_msg"},[(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},"购方开户银行："),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},"银行账户："),(0,l.Lk)("span",null,"----")])])]),(0,l.Lk)("div",{class:"invoicedialog_flot notice purchaser_text"},"销售方"),(0,l.Lk)("div",{class:"invoicedialog_flot notice_input notice_input_last"},[(0,l.Lk)("p",{class:"w-100"},[(0,l.Lk)("span",{class:"purchaser_text",style:{width:"84px",overflow:"hidden","vertical-align":"sub"}},[(0,l.Lk)("span",{style:{float:"left"}},"名"),(0,l.Lk)("span",{style:{float:"right"}},"称：")]),(0,l.Lk)("span",null,"---")]),(0,l.Lk)("p",{class:"w-100"},[(0,l.Lk)("span",{class:"purchaser_text"},"纳税人识别号："),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("p",{class:"more_msg"},[(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},[(0,l.Lk)("i",null,"销"),(0,l.Lk)("i",null,"方"),(0,l.Lk)("i",null,"地"),(0,l.Lk)("i",null,"址：")]),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},[(0,l.Lk)("i",null,"电"),(0,l.Lk)("i",null,"话：")]),(0,l.Lk)("span",null,"----")])]),(0,l.Lk)("p",{class:"more_msg"},[(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},"销方开户银行："),(0,l.Lk)("span",null,"----")]),(0,l.Lk)("section",null,[(0,l.Lk)("span",{class:"purchaser_text"},"银行账户："),(0,l.Lk)("span",null,"----")])])])],-1)),(0,l.Lk)("div",g,[(0,l.Lk)("div",v,[t[12]||(t[12]=(0,l.Lk)("div",{class:"table_p table_header"},[(0,l.Lk)("p",{style:{width:"293px"},class:"purchaser_text"},"项目名称"),(0,l.Lk)("p",{style:{width:"130px"},class:"purchaser_text"},"规格型号"),(0,l.Lk)("p",{style:{width:"103px"},class:"purchaser_text"},"单位"),(0,l.Lk)("p",{style:{width:"103px"},class:"purchaser_text"},"数量"),(0,l.Lk)("p",{style:{width:"138px"},class:"purchaser_text"},"单价"),(0,l.Lk)("p",{style:{width:"138px"},class:"purchaser_text"},"金额"),(0,l.Lk)("p",{style:{width:"93px"},class:"purchaser_text"},"税率/征收率"),(0,l.Lk)("p",{style:{width:"98px"},class:"purchaser_text"},"税额")],-1)),(0,l.Lk)("div",m,[(0,l.Lk)("div",y,[(0,l.Lk)("p",f,(0,a.v_)(e.label)+"费用",1),t[3]||(t[3]=(0,l.Lk)("p",{style:{width:"130px"}},"-",-1)),t[4]||(t[4]=(0,l.Lk)("p",{style:{width:"103px"}},"项",-1)),t[5]||(t[5]=(0,l.Lk)("p",{style:{width:"103px"}},"1",-1)),t[6]||(t[6]=(0,l.Lk)("p",{style:{width:"138px"}},"0.01",-1)),t[7]||(t[7]=(0,l.Lk)("p",{style:{width:"138px"}},"0.01",-1)),t[8]||(t[8]=(0,l.Lk)("p",{style:{width:"93px"}},"0.13",-1)),t[9]||(t[9]=(0,l.Lk)("p",{style:{width:"98px"}},"0.13",-1))]),((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)(4,e=>(0,l.Lk)("div",{class:"table_p table_center",key:e},[...t[10]||(t[10]=[(0,l.Lk)("p",{style:{width:"293px"}},null,-1),(0,l.Lk)("p",{style:{width:"130px"}},null,-1),(0,l.Lk)("p",{style:{width:"103px"}},null,-1),(0,l.Lk)("p",{style:{width:"103px"}},null,-1),(0,l.Lk)("p",{style:{width:"138px"}},null,-1),(0,l.Lk)("p",{style:{width:"138px"}},null,-1),(0,l.Lk)("p",{style:{width:"93px"}},null,-1),(0,l.Lk)("p",{style:{width:"98px"}},null,-1)])])),64)),t[11]||(t[11]=(0,l.Lk)("div",{class:"table_p table_center"},[(0,l.Lk)("p",{class:"purchaser_text",style:{width:"293px"}},"合计"),(0,l.Lk)("p",{style:{width:"130px"}}),(0,l.Lk)("p",{style:{width:"103px"}}),(0,l.Lk)("p",{style:{width:"103px"}}),(0,l.Lk)("p",{style:{width:"138px"}}),(0,l.Lk)("p",{style:{width:"138px"}},"¥0.01"),(0,l.Lk)("p",{style:{width:"93px"}}),(0,l.Lk)("p",{style:{width:"98px"}})],-1))])])]),t[15]||(t[15]=(0,l.Lk)("div",{class:"invoicedialog_tr"},[(0,l.Lk)("div",{class:"levied purchaser_text invoicedialog_flot"},"价税合计（大写）"),(0,l.Lk)("div",{class:"levied_text invoicedialog_flot"},[(0,l.Lk)("span",{style:{width:"446px",display:"inline-block"}},"元壹分"),(0,l.Lk)("span",{class:"purchaser_text"},"（小写）0.01")])],-1)),(0,l.Lk)("div",_,[t[13]||(t[13]=(0,l.Lk)("div",{class:"notice purchaser_text invoicedialog_flot"},"备 注",-1)),(0,l.Lk)("div",w,[(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":t=>z[e.name]=t,ref_for:!0,ref:"remarkTextarea",style:{margin:"0px",width:"100%",height:"100px",border:"none",resize:"none",outline:"none",padding:"5px","font-size":"12px","font-family":"inherit"},placeholder:`请输入${e.label}相关备注信息...`,onDrop:t=>B(t,e.name),onDragover:t[0]||(t[0]=(0,n.D$)(()=>{},["prevent"])),onDragenter:t[1]||(t[1]=(0,n.D$)(()=>{},["prevent"]))},null,40,x),[[n.Jo,z[e.name]]])])])])])]),(0,l.Lk)("div",b,[(0,l.Lk)("div",$,[(0,l.Lk)("div",I,[t[16]||(t[16]=(0,l.Lk)("span",{class:"variable-title"},"可用变量",-1)),(0,l.bF)(s,{size:"small",onClick:A,type:"text"},{default:(0,l.k6)(()=>[(0,l.eW)((0,a.v_)(T.value?"收起":"展开"),1)]),_:1})]),(0,l.bo)((0,l.Lk)("div",C,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(P,e=>((0,l.uX)(),(0,l.CE)("div",{class:"variable-category",key:e.name},[(0,l.Lk)("h4",R,(0,a.v_)(e.title),1),(0,l.Lk)("div",E,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(e.variables,e=>((0,l.uX)(),(0,l.CE)("span",{key:e.key,class:"variable-tag",draggable:!0,onDragstart:t=>U(t,e),onClick:t=>G(e),title:`${e.description} - ${e.value}`},[(0,l.eW)((0,a.v_)(e.display)+" ",1),(0,l.Lk)("code",D,(0,a.v_)(e.value),1)],40,K))),128))])]))),128))],512),[[n.aG,T.value]]),(0,l.Lk)("div",M,[(0,l.bF)(s,{type:"primary",onClick:Z,loading:q.value,size:"default",style:{width:"100%"}},{default:(0,l.k6)(()=>[(0,l.eW)((0,a.v_)(q.value?"保存中...":"保存配置"),1)]),_:1},8,["loading"])])])])])])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])])}}},W=s(66262);const X=(0,W.A)(j,[["__scopeId","data-v-6e0f0ac4"]]);var z=X}}]);